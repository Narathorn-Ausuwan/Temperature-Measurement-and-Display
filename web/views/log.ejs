<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempui</title>
    <link href="/css/pet-board.css" rel="stylesheet">
    <link href="/css/default-style.css" rel="stylesheet">
    <script src="/js/pet-board.js" defer></script>

</head>

<body>
    <div class="container">
        <b>Log</b>
        <hr>
    </div>

    <div class="container log-list">

    </div>

    <script>
        const influxData = JSON.parse('<%- JSON.stringify(influxData).replace(/</g, "\\u003c") %>');

        // แปลงเวลาให้อ่านง่าย
        let tableData = influxData.temperature.map(item => {
            const date = new Date(item.time);
            const timeStr = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
            return {
                timestamp: date.getTime(), // ใช้สำหรับ sort
                time: timeStr,
                device: item.deviceName,
                location: item.location,
                temperature: item.value
            };
        });

        // Pagination variables
        const rowsPerPage = 25;
        let currentPage = 1;
        const totalPages = Math.ceil(tableData.length / rowsPerPage);

        // สถานะการเรียง
        let sortAscending = true; // เริ่มต้นเรียงจากเก่า → ใหม่

        function renderTable(page) {
            // เรียงข้อมูลตามเวลา
            tableData.sort((a, b) => sortAscending ? a.timestamp - b.timestamp : b.timestamp - a.timestamp);

            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const rows = tableData.slice(start, end);

            let tableHTML = `
                <div class="sort-btn-container">
                    <button id="sortBtn">${sortAscending ? 'ASC' : 'DESC'}</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Device</th>
                            <th>Location</th>
                            <th>Temperature (°C)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            rows.forEach(row => {
                tableHTML += `
            <tr>
                <td>${row.time}</td>
                <td>${row.device}</td>
                <td>${row.location}</td>
                <td>${row.temperature.toFixed(2)}</td>
            </tr>
        `;
            });

            tableHTML += `</tbody></table>`;

            // Pagination buttons
            tableHTML += `<div class="pagination">`;
            tableHTML += `<button id="prevBtn" ${page === 1 ? 'disabled' : ''}>Previous</button>`;
            tableHTML += `<span> Page ${page} of ${totalPages} </span>`;
            tableHTML += `<button id="nextBtn" ${page === totalPages ? 'disabled' : ''}>Next</button>`;
            tableHTML += `</div>`;

            document.querySelector('.log-list').innerHTML = tableHTML;

            // Event listeners
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const sortBtn = document.getElementById('sortBtn');

            if (prevBtn) prevBtn.addEventListener('click', () => { currentPage--; renderTable(currentPage); });
            if (nextBtn) nextBtn.addEventListener('click', () => { currentPage++; renderTable(currentPage); });
            if (sortBtn) sortBtn.addEventListener('click', () => {
                sortAscending = !sortAscending;
                currentPage = 1; // เริ่มจากหน้าแรกหลังสลับ
                renderTable(currentPage);
            });
        }

        // แสดงหน้าแรก
        renderTable(currentPage);
    </script>

</body>

</html>